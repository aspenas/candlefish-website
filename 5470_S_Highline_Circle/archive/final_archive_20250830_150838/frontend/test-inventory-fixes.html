<!DOCTYPE html>
<html>
<head>
    <title>Test Inventory System Fixes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { margin: 5px; padding: 8px 12px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        .loading { color: #666; }
    </style>
</head>
<body>
    <h1>Inventory System Test Suite</h1>
    <p>Testing the fixes applied to the inventory system:</p>

    <div class="test-section">
        <h2>1. Backend API Health Check</h2>
        <button onclick="testAPIHealth()">Test API Health</button>
        <div id="health-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Items List Retrieval</h2>
        <button onclick="testItemsList()">Get Items List</button>
        <div id="items-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Individual Item Retrieval</h2>
        <button onclick="testIndividualItem()">Get Individual Item</button>
        <div id="individual-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Decision Update Test</h2>
        <button onclick="testDecisionUpdate()">Test Decision Update</button>
        <div id="decision-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Case Conversion Test</h2>
        <button onclick="testCaseConversion()">Test camelCase/snake_case Conversion</button>
        <div id="conversion-result"></div>
    </div>

    <script>
        const API_BASE = 'https://5470-inventory.fly.dev/api/v1';

        // Helper function to convert snake_case to camelCase
        const toCamelCase = (obj) => {
            if (obj === null || obj === undefined || typeof obj !== 'object') {
                return obj;
            }
            
            if (Array.isArray(obj)) {
                return obj.map(toCamelCase);
            }
            
            const camelCaseObj = {};
            for (const [key, value] of Object.entries(obj)) {
                const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
                camelCaseObj[camelKey] = toCamelCase(value);
            }
            return camelCaseObj;
        };

        // Helper function to convert camelCase to snake_case
        const toSnakeCase = (obj) => {
            if (obj === null || obj === undefined || typeof obj !== 'object') {
                return obj;
            }
            
            if (Array.isArray(obj)) {
                return obj.map(toSnakeCase);
            }
            
            const snakeCaseObj = {};
            for (const [key, value] of Object.entries(obj)) {
                const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
                snakeCaseObj[snakeKey] = toSnakeCase(value);
            }
            return snakeCaseObj;
        };

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="loading">Testing...</div>';
        }

        function showResult(elementId, success, message, data = null) {
            const className = success ? 'success' : 'error';
            let html = `<div class="${className}">${message}</div>`;
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            document.getElementById(elementId).innerHTML = html;
        }

        async function testAPIHealth() {
            showLoading('health-result');
            try {
                const response = await fetch('https://5470-inventory.fly.dev/health');
                const data = await response.json();
                if (data.status === 'healthy') {
                    showResult('health-result', true, '✓ Backend API is healthy', data);
                } else {
                    showResult('health-result', false, '✗ API health check failed', data);
                }
            } catch (error) {
                showResult('health-result', false, `✗ Network error: ${error.message}`);
            }
        }

        async function testItemsList() {
            showLoading('items-result');
            try {
                const response = await fetch(`${API_BASE}/items`);
                const data = await response.json();
                const itemCount = data.items ? data.items.length : 0;
                if (itemCount > 0) {
                    const firstItem = data.items[0];
                    showResult('items-result', true, `✓ Retrieved ${itemCount} items`, {
                        totalItems: itemCount,
                        firstItemSample: firstItem,
                        camelCaseConverted: toCamelCase(firstItem)
                    });
                } else {
                    showResult('items-result', false, '✗ No items found', data);
                }
            } catch (error) {
                showResult('items-result', false, `✗ Error fetching items: ${error.message}`);
            }
        }

        async function testIndividualItem() {
            showLoading('individual-result');
            try {
                // First get a list to find an item ID
                const listResponse = await fetch(`${API_BASE}/items`);
                const listData = await listResponse.json();
                
                if (!listData.items || listData.items.length === 0) {
                    showResult('individual-result', false, '✗ No items available to test individual retrieval');
                    return;
                }

                const itemId = listData.items[0].id;
                const itemResponse = await fetch(`${API_BASE}/items/${itemId}`);
                const itemData = await itemResponse.json();
                
                if (itemData.item) {
                    showResult('individual-result', true, '✓ Individual item retrieval working', {
                        requestedId: itemId,
                        retrieved: itemData.item
                    });
                } else {
                    // Try fallback approach
                    const foundItem = listData.items.find(item => item.id === itemId);
                    if (foundItem) {
                        showResult('individual-result', false, '✗ Individual endpoint returns null, but fallback working', {
                            endpointResponse: itemData,
                            fallbackItem: foundItem
                        });
                    } else {
                        showResult('individual-result', false, '✗ Individual item retrieval failed', itemData);
                    }
                }
            } catch (error) {
                showResult('individual-result', false, `✗ Error: ${error.message}`);
            }
        }

        async function testDecisionUpdate() {
            showLoading('decision-result');
            try {
                // Get first item
                const response = await fetch(`${API_BASE}/items`);
                const data = await response.json();
                
                if (!data.items || data.items.length === 0) {
                    showResult('decision-result', false, '✗ No items available for testing');
                    return;
                }

                const item = data.items[0];
                const originalDecision = item.decision;
                const newDecision = originalDecision === 'Keep' ? 'Sell' : 'Keep';
                
                console.log(`Testing decision update: ${originalDecision} -> ${newDecision}`);
                
                // Update item decision
                const updateResponse = await fetch(`${API_BASE}/items/${item.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision: newDecision })
                });
                
                const updateResult = await updateResponse.json();
                console.log('Update response:', updateResult);

                // Check if update worked
                const verifyResponse = await fetch(`${API_BASE}/items`);
                const verifyData = await verifyResponse.json();
                const updatedItem = verifyData.items.find(i => i.id === item.id);
                
                if (updatedItem.decision === newDecision) {
                    showResult('decision-result', true, `✓ Decision update successful: ${originalDecision} -> ${newDecision}`, {
                        itemId: item.id,
                        itemName: item.name,
                        originalDecision,
                        newDecision,
                        actualDecision: updatedItem.decision,
                        updateResponse: updateResult
                    });
                } else {
                    showResult('decision-result', false, `✗ Decision update failed - not persisted`, {
                        itemId: item.id,
                        itemName: item.name,
                        originalDecision,
                        requestedDecision: newDecision,
                        actualDecision: updatedItem.decision,
                        updateResponse: updateResult
                    });
                }
            } catch (error) {
                showResult('decision-result', false, `✗ Error testing decision update: ${error.message}`);
            }
        }

        function testCaseConversion() {
            showLoading('conversion-result');
            
            const testSnakeCase = {
                created_at: "2025-08-29T02:21:45Z",
                is_fixture: false,
                image_count: 5,
                invoice_ref: "INV-123"
            };
            
            const testCamelCase = {
                createdAt: "2025-08-29T02:21:45Z",
                isFixture: false,
                imageCount: 5,
                invoiceRef: "INV-123"
            };
            
            const converted1 = toCamelCase(testSnakeCase);
            const converted2 = toSnakeCase(testCamelCase);
            
            const success1 = converted1.createdAt === testSnakeCase.created_at && 
                           converted1.isFixture === testSnakeCase.is_fixture &&
                           converted1.imageCount === testSnakeCase.image_count;
                           
            const success2 = converted2.created_at === testCamelCase.createdAt && 
                           converted2.is_fixture === testCamelCase.isFixture &&
                           converted2.image_count === testCamelCase.imageCount;
            
            if (success1 && success2) {
                showResult('conversion-result', true, '✓ Case conversion working correctly', {
                    snakeToCarmel: { input: testSnakeCase, output: converted1 },
                    camelToSnake: { input: testCamelCase, output: converted2 }
                });
            } else {
                showResult('conversion-result', false, '✗ Case conversion not working properly', {
                    snakeToCarmel: { input: testSnakeCase, output: converted1, success: success1 },
                    camelToSnake: { input: testCamelCase, output: converted2, success: success2 }
                });
            }
        }

        // Run tests automatically
        window.onload = function() {
            console.log('Running automated tests...');
            setTimeout(() => testAPIHealth(), 500);
            setTimeout(() => testItemsList(), 1000);
            setTimeout(() => testIndividualItem(), 1500);
            setTimeout(() => testCaseConversion(), 2000);
            setTimeout(() => testDecisionUpdate(), 2500);
        };
    </script>
</body>
</html>